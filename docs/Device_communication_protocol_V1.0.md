# Протокол общения с устройствами

ВЕРСИЯ 1.0

## Общие положения

Адресс устройства имеет формат `http://device_addr:device_port/`
Далее для простоты восприятия полный адрес будет опускаться, например вместо `http://device_addr:device_port/status` будет просто `/status`.

Доступные запросы:

* Запрос статуса
* Запрос логов
* Запуск action
* Остановка action
* Запрос информации из service

Ответы на запросы всегда в формате JSON.

[!] В некоторых примерах будет добавлен символ `...` - данный символ обозначет, что элементов может быть больше чем один.

[!] Для обратной своместимости все списки параметров запросов формата GET оканчиваются символом `&`.

## Запрос статуса

Для запроса статуса может выглядить несколькими способами:

* `/status[?param=value[&param2=value2]&]`
* `/run?cmd=status[?param=value[&param2=value2[...]]&]`

Доступные параметры:

* **action** - например, `action="name[,name2[...]]"`. Параметр указывает что нужно вернуть статус конкретных экшенов. Имена экшенов перечислены через запятую.
* *список параметров будет расширяться*

Ответ на запрос статуса будет выглядеть следующим образом:

```json
{
  "name": str - device name,
  "rc": "int - request result code",
  "info": "str - text interpretation of return code",
  "state": "str - global device status: init | run | fail",
  "action_list": [
    {
      "name": "str - action_name",
      "state": "str - action status: none | init | run | succsess | fail",
      "info": "str - any information",
      "st_time": "int - timestamp of last start",
      "fin_time": "int - timestamp of finish",
      "result": "int - action result code"
    },
    ...
  ]
}
```

Значения параметра **rc**:

* `0` - запрос выполнен успешно
* `-1` - неверные параметры
* `-2` - action с таким именем не найден

**action_list** содержит в себе массив статусов экшеном. По умолчанию (запрос без параметров), возвращается массив статусов активных на данный момент экшенов. Если были указаны имена экшенов с помощью параметра **action**, то action_list содержит статусы указанных экшенов. При этом не важно был ли этот экшен запущен на момент запроса.

## Запрос логов

Запрос логов осуществляется по адресу: `/history?type=value[&name=value2[&n=20]]&`
Протокол относительно запроса логов будет доработан позднее.

Доступные параметры:

* **type** - тип запрашиваемых логов. Может быть: *action*, *system*
* **name** - используется с типом *action*, позволяет указать конкретные имена экшенов, историю статусов которых нужно вернуть
* **n** - верхнее ограничение на количество возвращаемых элементов
* *список будет расширяться*

Ответ на запрос логов имеет вид:

```json
{
  "rc": "int - request result code",
  "info": "str - text interpretation of return code"
  "data": [
    ...
  ]
}
```

Если значение type - **action**, то поле data содержит массив объектов типа статус action, для всех action, имена которых были указаны в параметре **name**, или для всех action, если параметр name не задан.

Если type - **system**, то data содержит массив строк (возможно нужно разбивать строку на поля: метка времени, тип и сообщение).

## Запуск Action

Запуск action можно осуществить двумя способами:

* `/action?name=action_name[&param=value[...]]&`
* `/run?cmd=action_name[&param=value[...]]&`

Параметров может быть много, а может и вообще не быть.
Все параметры в формате GET, например: `/action?name=act_name&param1=value1&param2=value2&`.

Ответ на запрос запуска action выглядит следующим образом:

```json
{
  "name": "str - action name",
  "rc": "int - request result code",
  "info": "str - text interpretation of return code"
}
```

Предопределённые значения `rc`:

* `0` - action запущен
* `-1` - action с таким именем не найден
* `-2` - action с таким именем не запустился
* `-3` - action с таким именем уже запущен

## Остановка Action

Запуск action осуществляется запросом вида: `/reset[?action=action_names&]`

Доступные параметры:

* **action** - например, `action="name[,name2[...]]"`. Параметр указывает что нужно остановить конкретные экшены. Имена экшенов перечислены через запятую. Если параметр не указан, будут звершены все активные action.

Ответ на запрос остановки action будет выглядеть следующим образом:

```json
{
  "name": "reset",
  "rc": "int - request result code",
  "info": "str - text interpretation of return code"
  "data": {
    "action_name1": "int - reset_status"
    ...
  }
}
```

Поле **data** в ответе будет содержать словарь, в котором ключ - имя action, значение - код запуска операции остановки. Если были заданы имена конкретных action через пераметр *action*, то словарь будет содержать столько значений, сколько экшенов было указано.
В противном случае в словаре будет столько значений, сколько активных экшенов было на момент запроса. 

Предопределённые значения `rc`:

* `0` - команда выполнена успешно
* `-1` - не все перечисленные action удалось найти

Предопределённые значения *reset_status*:

* `0` - операция остановки успешно запущена
* `-1` - произошла ошибка при попытке остановки
* `-2` - action не запущен

## Запрос информации из service

Запрос осуществляется по адресу `/service?name=service_name[&param=value[...]]&`

Параметров может быть много, а может и вообще не быть.

[!] Рассматривается вариант сделать, чтобы **service_name** мог содержать несколько имён, разделённых между собой запятыми. Но к этому подходу есть вопросы.

Ответ на запрос информации из service выглядит следующим образом:

```json
{
  "name": "str - service name",
  "rc": "int - request result code",
  "info": "str - text interpretation of return code"
  "data": {
    "param_name": "param_value"
    ...
  }
}
```

Предопределённые значения `rc`:

* `0` - запрос успешный
* `-1` - service с таким именем не найден
* `-2` - service с таким именем не ответил

Каждое устройство имеем два обязательных сервиса:

* **getactions** - возвращает список доступных экшенов
* **getservices** - возвращает список доступных сервисов
