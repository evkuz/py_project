<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<link rel="shortcut icon" href="style/images/favicon.png">
<title>Robot Control Center</title>
<!-- Bootstrap core CSS -->
<link href="style/css/bootstrap.min.css" rel="stylesheet">
<link href="style/css/plugins.css" rel="stylesheet">
<link href="style.css" rel="stylesheet">
<link href="style/css/color/red.css" rel="stylesheet">
<link href="style/type/bebas.css" rel="stylesheet">
<link href="style/type/fontello.css" rel="stylesheet">
<script>
  iqrSupervisor = {
    vehicleAddr: "http://127.0.0.1:5000",
    manipulatorAddr: "http://127.0.0.1:5000"
  };
</script>
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="style/js/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
      <![endif]-->
</head>
<body>
<div id="prelo  ader"><div id="status"><div class="spinner"></div></div></div>
<div class="body-wrapper">
  <div class="offset"></div>
  <div class="dark-wrapper intro">
    <div class="container inner">
      <h1> Robot Control Center </h1>
      <p>Simulation of the target installation.</p>
      <div style="float:right;margin-top:-49px;">
        <a class="btn btn-red" id="start_tp">Start tech process</a>
      </div>
    </div>
    <!--/.container -->
  </div>
  <!--/.intro -->
  
  <div class="container inner">
    <div class="row text-center services-1">
      <div class="col-sm-6">
        <div class="col-wrapper">
          <h3>Vehicle camera</h3>
          <img src="http://localhost:5000/video_feed" width="550" height="412" id="vehicle_cam">
          <div id="vehicle_status"></div>
        </div>
      </div>
      <div class="col-sm-6">
        <div class="col-wrapper">
          <h3>Manipulator camera</h3>
          <img src="http://localhost:5000/video_feed" width="550" height="412" id="manipulator_cam">
          <div id="manipulator_status"></div>
        </div>
      </div>
    </div>
    <!-- /.services -->
    
  </div>
  <!--/.container -->
    
    <div class="sub-footer">
      <div class="container">
        <p class="pull-left">Â© 2021 IQR LIT. All rights reserved.</p>
      </div>
    </div>
  </footer>
  <!-- /footer --> 
 
</div>
<!--/.body-wrapper --> 
<script src="style/js/jquery.min.js"></script> 
<script src="style/js/bootstrap.min.js"></script> 
<script src="style/js/plugins.js"></script> 
<script src="style/js/scripts.js"></script>
<script>/*<![CDATA[*/
  var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status === 200) {
        callback(null, xhr.response);
      } else {
        callback(status, xhr.response);
      }
    };
    xhr.onerror= function(e) {
      callback("Connection error", null);
    };
    xhr.ontimeout = function (e) {
      callback("Connection timeout", null);
    }
    xhr.send();
  };
  
  document.getElementById("vehicle_cam").src=iqrSupervisor.vehicleAddr+"/video_feed";
  document.getElementById("manipulator_cam").src=iqrSupervisor.manipulatorAddr+"/video_feed";

  vehicleState = {
    lastCmd: "none",
    lastCmdResult: 0,
    status: "wait",
    connection: false,
    errorMsg: null
  };

  manipulatorState = {
    lastCmd: "none",
    lastCmdResult: 0,
    status: "wait",
    connection: false,
    errorMsg: null
  };
  
  updManipulatorState = function(){
    getJSON(
        iqrSupervisor.manipulatorAddr+'/'+"run",
        function(status, data) {
          if (status === null) {
            manipulatorState.connection = true;
            manipulatorState.status = data.status;
            manipulatorState.lastCmd = data.lastCmd;
            manipulatorState.lastCmdResult = data.lastCmdResult;
          } else {
            manipulatorState.connection = false;
            manipulatorState.errorMsg = status;
          }
        }
    );
    statusElem = document.getElementById("manipulator_status");
    if ( manipulatorState.connection ) {
       statusElem.innerHTML = "<div class='alert alert-warning'>Current state: <strong>" +
                              manipulatorState.status +                     
                              "</strong></div>";
    } else {
       statusElem.innerHTML ="<div class='alert alert-danger'> <strong>Connection failed!</strong> Message:" +
                              manipulatorState.errorMsg +
                              " </div>";
    }
  };

  updVehicleState = function(){
    getJSON(
        iqrSupervisor.vehicleAddr+'/'+"run",
        function(status, data) {
          if (status === null) {
            vehicleState.connection = true;
            vehicleState.status = data.status;
            vehicleState.lastCmd = data.lastCmd;
            vehicleState.lastCmdResult = data.lastCmdResult;
          } else {
            vehicleState.connection = false;
            vehicleState.errorMsg = status;
          }
        }
    );
    statusElem = document.getElementById("vehicle_status");
    if ( vehicleState.connection ) {
       statusElem.innerHTML = "<div class='alert alert-warning'>Current state: <strong>" +
                              vehicleState.status +                     
                              "</strong></div>";
    } else {
       statusElem.innerHTML ="<div class='alert alert-danger'> <strong>Connection failed!</strong> Message:" +
                              vehicleState.errorMsg +
                              " </div>";
    }
    

  };

  const stateInterval = setInterval(
    () => {
      updManipulatorState();
      updVehicleState();
    },
    200
  );

  var tpIntervalId;

    startBtn = document.getElementById("start_tp")
    startBtn.onclick = function(){
      btn = document.getElementById("start_tp")
      if ( btn.classList.contains('btn-red') ){
        btn.classList.remove('btn-red');
        btn.classList.add('btn-gray');
        updManipulatorState();
        updVehicleState();
        //tpIntervalId = setInterval(() => {
        //    if (vecState == "done" && manState == "done") {
        //      clearInterval(tpIntervalId);
        //      console.log('Done');
        //    }
        //  },
        //  50
        //);
      } else {
        btn.classList.remove('btn-gray');
        btn.classList.add('btn-red');
      }
    };
  /*]]>*/
</script>
</body>
</html>